{% extends 'base.html.twig' %}

{% block body %}
<header>
<!-- Hero -->
    <section class="hero" style="background: linear-gradient(135deg, #1abc9c, #16a085); color: white; padding: 60px 20px 40px 20px; text-align: center; border-radius: 8px; margin-bottom: 40px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <h1 style="font-size: 2.2rem; font-weight: 700; margin-bottom: 15px;">Gestion des candidatures</h1>
        <p style="font-size: 1.1rem; max-width: 700px; margin: 0 auto 25px; line-height: 1.5;">
            Organisez, suivez et optimisez vos candidatures, relances et entretiens en toute simplicité.
        </p>
        <a href="{{ path('candidature_new') }}" style="background-color: white; color: #16a085; font-weight: 600; padding: 12px 30px; border-radius: 50px; text-decoration: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: background-color 0.3s;">
            Ajouter une candidature
        </a>
    </section>

     <!-- Features -->
    <section class="features" style="display: flex; justify-content: center; gap: 40px; flex-wrap: wrap; margin-bottom: 40px;">
        <div class="feature-box" style="text-align:center; width:250px;">
            <i class="fas fa-list-check" style="font-size:2rem; color:#1abc9c; margin-bottom:10px;"></i>
            <h3>Suivi facile</h3>
            <p>Organisez toutes vos candidatures en un seul tableau simple et intuitif.</p>
        </div>
        <div class="feature-box" style="text-align:center; width:250px;">
            <i class="fas fa-bell" style="font-size:2rem; color:#1abc9c; margin-bottom:10px;"></i>
            <h3>Alertes et relances</h3>
            <p>Recevez des rappels pour vos relances et entretiens programmés.</p>
        </div>
        <div class="feature-box" style="text-align:center; width:250px;">
            <i class="fas fa-chart-line" style="font-size:2rem; color:#1abc9c; margin-bottom:10px;"></i>
            <h3>Statistiques claires</h3>
            <p>Visualisez vos progrès et vos opportunités de manière graphique.</p>
        </div>
    </section>

    <h1>Mes candidatures</h1>
    
</header>



<!-- Bouton Ajouter -->
<div style="text-align:center; margin:20px;">
    <a href="{{ path('candidature_new') }}" class="btn-add" 
       style="background-color:#27AE60; color:white; padding:10px 20px; border-radius:5px; text-decoration:none; font-weight:bold;">
        ➕ Nouvelle candidature
    </a>
</div>

<!-- Kanban -->
<div class="kanban" style="display:flex; gap:20px; justify-content:center; padding:20px;">

    <!-- Colonne Candidature -->
    <div class="column" id="col-candidature" style="background-color:#ECF0F1; padding:15px; border-radius:8px; width:300px; min-height:400px; box-shadow:0 2px 5px rgba(0,0,0,0.2);">
        <h2 style="text-align:center; margin-bottom:15px;">Candidature envoyée</h2>
        {% for candidature in candidatures %}
            {% if candidature.statut == 'Candidature' %}
                <div class="card" draggable="true" data-id="{{ candidature.id }}" style="background:white; padding:10px; margin-bottom:10px; border-radius:5px; box-shadow:0 1px 3px rgba(0,0,0,0.2); cursor:grab;">
                    <strong>{{ candidature.nom }}</strong><br>
                    {% if candidature.lien %}
                        <a href="{{ candidature.lien }}" target="_blank" style="color:#2980B9; text-decoration:none;">Voir l'offre</a>
                    {% endif %}

                    <form action="{{ path('candidature_delete', {'id': candidature.id}) }}" method="post" style="display:inline-block; margin-top:5px;" onsubmit="return confirm('Voulez-vous vraiment supprimer cette candidature ?');">
                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ candidature.id) }}">
                        <button type="submit" style="background:green; color:white; border:none; border-radius:3px; padding:3px 6px; cursor:pointer; font-size:0.85rem;">
                            Supprimer
                        </button>
                    </form>
                </div>
            {% endif %}
        {% endfor %}
    </div>

    <!-- Colonne Relance -->
    <div class="column" id="col-relance" style="background-color:#FDEBD0; padding:15px; border-radius:8px; width:300px; min-height:400px; box-shadow:0 2px 5px rgba(0,0,0,0.2);">
        <h2 style="text-align:center; margin-bottom:15px;">Relance</h2>
        {% for candidature in candidatures %}
            {% if candidature.statut == 'Relance' %}
                <div class="card" draggable="true" data-id="{{ candidature.id }}" style="background:white; padding:10px; margin-bottom:10px; border-radius:5px; box-shadow:0 1px 3px rgba(0,0,0,0.2); cursor:grab;">
                    <strong>{{ candidature.nom }}</strong><br>
                    {% if candidature.lien %}
                        <a href="{{ candidature.lien }}" target="_blank" style="color:#2980B9; text-decoration:none;">Voir l'offre</a>
                    {% endif %}
                    <form action="{{ path('candidature_delete', {'id': candidature.id}) }}" method="post" style="display:inline-block; margin-top:5px;" onsubmit="return confirm('Voulez-vous vraiment supprimer cette candidature ?');">
                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ candidature.id) }}">
                        <button type="submit" style="background:green; color:white; border:none; border-radius:3px; padding:3px 6px; cursor:pointer; font-size:0.85rem;">
                            Supprimer
                        </button>
                    </form>
                </div>
            {% endif %}
        {% endfor %}
    </div>

    <!-- Colonne Entretien -->
    <div class="column" id="col-entretien" style="background-color:#D6EAF8; padding:15px; border-radius:8px; width:300px; min-height:400px; box-shadow:0 2px 5px rgba(0,0,0,0.2);">
        <h2 style="text-align:center; margin-bottom:15px;">Entretien</h2>
        {% for candidature in candidatures %}
            {% if candidature.statut == 'Entretien' %}
                <div class="card" draggable="true" data-id="{{ candidature.id }}" style="background:white; padding:10px; margin-bottom:10px; border-radius:5px; box-shadow:0 1px 3px rgba(0,0,0,0.2); cursor:grab;">
                    <strong>{{ candidature.nom }}</strong><br>
                    {% if candidature.lien %}
                        <a href="{{ candidature.lien }}" target="_blank" style="color:#2980B9; text-decoration:none;">Voir l'offre</a>
                    {% endif %}
                    <form action="{{ path('candidature_delete', {'id': candidature.id}) }}" method="post" style="display:inline-block; margin-top:5px;" onsubmit="return confirm('Voulez-vous vraiment supprimer cette candidature ?');">
        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ candidature.id) }}">
        <button type="submit" style="background:green; color:white; border:none; border-radius:3px; padding:3px 6px; cursor:pointer; font-size:0.85rem;">
            Supprimer
        </button>
    </form>
                </div>
                
            {% endif %}
        {% endfor %}
    </div>

</div>

<!-- Statistiques -->
<section class="features" style="display: flex; justify-content: center; gap: 40px; flex-wrap: wrap; margin-bottom: 40px;">
    <div class="feature-box" style="text-align:center; width:250px;">
        <i class="fas fa-envelope" style="font-size:2rem; color:#1abc9c; margin-bottom:10px;"></i>
        <h3>{{ countCandidature }}</h3>
        <p>Candidatures envoyées</p>
    </div>
    <div class="feature-box" style="text-align:center; width:250px;">
        <i class="fas fa-bell" style="font-size:2rem; color:#1abc9c; margin-bottom:10px;"></i>
        <h3>{{ countRelance }}</h3>
        <p>Relances prévues</p>
    </div>
    <div class="feature-box" style="text-align:center; width:250px;">
        <i class="fas fa-user-check" style="font-size:2rem; color:#1abc9c; margin-bottom:10px;"></i>
        <h3>{{ countEntretien }}</h3>
        <p>Entretiens programmés</p>
    </div>
</section>



<!-- Drag & Drop Script -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    const cards = document.querySelectorAll('.card');
    const columns = document.querySelectorAll('.column');
    let draggedCard = null;

    cards.forEach(card => {
        card.addEventListener('dragstart', e => {
            draggedCard = card;
            setTimeout(() => card.style.display = 'none', 0);
        });
        card.addEventListener('dragend', e => {
            setTimeout(() => {
                draggedCard.style.display = 'block';
                draggedCard = null;
            }, 0);
        });
    });

    columns.forEach(column => {
        column.addEventListener('dragover', e => e.preventDefault());

        column.addEventListener('drop', e => {
            if (!draggedCard) return;

            column.appendChild(draggedCard);

            // Récupère l'ID de la candidature
            const candidatureId = draggedCard.dataset.id;

            // Détermine le nouveau statut selon la colonne
            const newStatut = column.id === 'col-candidature' ? 'Candidature'
                            : column.id === 'col-relance' ? 'Relance'
                            : 'Entretien';

            // Envoie le nouveau statut au serveur via AJAX
            fetch(`/candidature/${candidatureId}/statut`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: `statut=${newStatut}`
            });
        });
    });
});
</script>
{% endblock %}
